import jwt from "jsonwebtoken";
import dotenv from "dotenv";

dotenv.config();

// Tạo accessToken và refreshToken
export const generateToken = (user) => {
  const payload = { id: user.id, username: user.username, phone: user.phone };

  const accessToken = jwt.sign(payload, process.env.JWT_ACCESS_SECRET_KEY, {
    expiresIn: process.env.JWT_ACCESS_EXPIRES_IN,
  });

  const refreshToken = jwt.sign(payload, process.env.JWT_REFRESH_SECRET_KEY, {
    expiresIn: process.env.JWT_REFRESH_EXPIRES_IN,
  });

  return { accessToken, refreshToken };
};

// Kiểm tra accessToken và refreshToken
export const verifyAndRefreshToken = async (accessToken, refreshToken) => {
  try {
    // Kiểm tra accessToken còn hợp lệ không
    const decodedAccessToken = jwt.verify(accessToken, process.env.JWT_ACCESS_SECRET_KEY);
    return { valid: true, accessToken, refreshToken }; // Token vẫn còn hạn
  } catch (error) {
    if (error.name === "TokenExpiredError") {
      console.log("AccessToken hết hạn, kiểm tra RefreshToken...");
      try {
        // Kiểm tra refreshToken
        const decodedRefreshToken = jwt.verify(refreshToken, process.env.JWT_REFRESH_SECRET_KEY);
        console.log("RefreshToken hợp lệ, tạo accessToken mới...");

        // Tạo accessToken mới
        const newAccessToken = jwt.sign(
          { id: decodedRefreshToken.id, username: decodedRefreshToken.username, phone: decodedRefreshToken.phone },
          process.env.JWT_ACCESS_SECRET_KEY,
          { expiresIn: process.env.JWT_ACCESS_EXPIRES_IN }
        );

        return { valid: true, accessToken: newAccessToken, refreshToken };
      } catch (refreshError) {
        console.log("RefreshToken hết hạn, yêu cầu đăng nhập lại!");
        return { valid: false }; // Cả accessToken & refreshToken đều hết hạn
      }
    } else {
      console.log("AccessToken không hợp lệ!");
      return { valid: false }; // Token sai hoặc lỗi khác
    }
  }
};
